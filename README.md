# ğŸµ Rhythmix

<div align="center">

![Version](https://img.shields.io/badge/ç‰ˆæœ¬-1.0.0-blue)
![License](https://img.shields.io/badge/è®¸å¯è¯-MIT-green)

</div>

> **Rhythmix**ï¼ˆå¯ä»¥ç†è§£ä¸º"èŠ‚å¥æ··åˆ"ï¼‰æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„æµæ•°æ®å¤„ç†è§„åˆ™è¡¨è¾¾å¼å¼•æ“ã€‚å®ƒèƒ½å¤Ÿåœ¨æµæ•°æ®ä¸­æ‰¾å‡ºç¬¦åˆç‰¹å®šè§„å¾‹ï¼ˆèŠ‚å¥ï¼‰çš„æ•°æ®ï¼Œå°±åƒæŒ‰ç…§æŸç§èŠ‚å¥è¿ä½œä¸€æ ·ã€‚

## ğŸ“‘ ç›®å½•

- [ğŸµ Rhythmix](#-rhythmix)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸš€ é¡¹ç›®ç®€ä»‹](#-é¡¹ç›®ç®€ä»‹)
  - [ğŸ å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
    - [åŸºæœ¬ç¤ºä¾‹](#åŸºæœ¬ç¤ºä¾‹)
    - [çŠ¶æ€è½¬æ¢ç¤ºä¾‹](#çŠ¶æ€è½¬æ¢ç¤ºä¾‹)
  - [ğŸ“ è¡¨è¾¾å¼è¯­æ³•](#-è¡¨è¾¾å¼è¯­æ³•)
    - [ç®­å¤´è¡¨è¾¾å¼](#ç®­å¤´è¡¨è¾¾å¼)
    - [çŠ¶æ€è¡¨è¾¾å¼](#çŠ¶æ€è¡¨è¾¾å¼)
      - [æ¯”è¾ƒè¡¨è¾¾å¼](#æ¯”è¾ƒè¡¨è¾¾å¼)
      - [åŒºé—´è¡¨è¾¾å¼](#åŒºé—´è¡¨è¾¾å¼)
      - [é€»è¾‘è¡¨è¾¾å¼](#é€»è¾‘è¡¨è¾¾å¼)
    - [é“¾å¼è¡¨è¾¾å¼](#é“¾å¼è¡¨è¾¾å¼)
      - [æ•°æ®è¿‡æ»¤](#æ•°æ®è¿‡æ»¤)
      - [æ•°æ®é™åˆ¶](#æ•°æ®é™åˆ¶)
      - [æ•°æ®è®¡ç®—](#æ•°æ®è®¡ç®—)

## ğŸš€ é¡¹ç›®ç®€ä»‹

Rhythmix æ˜¯ä¸€ä¸ªä¸“ä¸ºæµæ•°æ®å¤„ç†è®¾è®¡çš„è§„åˆ™è¡¨è¾¾å¼å¼•æ“ã€‚å®ƒå¯ä»¥åº”ç”¨äºå¤šç§åœºæ™¯ï¼Œç‰¹åˆ«é€‚åˆï¼š

- ç”Ÿäº§ç¯å¢ƒç›‘æ§
- å®æ—¶æ•°æ®åˆ†æ
- å¼‚å¸¸æ£€æµ‹ä¸æŠ¥è­¦
- ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†

é€šè¿‡ç®€æ´è€Œå¼ºå¤§çš„è¡¨è¾¾å¼è¯­æ³•ï¼ŒRhythmix ä½¿å¤æ‚çš„æ•°æ®å¤„ç†è§„åˆ™å˜å¾—ç®€å•æ˜“ç”¨ã€‚

## ğŸ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ Rhythmix

```js
count(>4,3)
```

è¿™è¡Œè¡¨è¾¾å¼çš„æ„æ€æ˜¯ï¼šå½“å€¼å¤§äº 4 å¹¶ä¸”æ»¡è¶³ 3 æ¬¡ï¼ˆéè¿ç»­ä¸‰æ¬¡ï¼‰ä¹‹åè¿”å›çœŸã€‚

![count1](doc/media/videos/300p60/count1.gif)

åœ¨ Java ä»£ç ä¸­ä½¿ç”¨è¯¥è¡¨è¾¾å¼ï¼š

```java
// ç¼–è¯‘è¡¨è¾¾å¼
String code = "count(>4,3)";
Executor exe = Compiler.compile(code);

// æ„é€ æµ‹è¯•æ•°æ®
SensorEvent p1 = Util.genEventData("11", "1", new Timestamp(System.currentTimeMillis()));
SensorEvent p2 = Util.genEventData("12", "11", new Timestamp(System.currentTimeMillis()+100));
SensorEvent p3 = Util.genEventData("13", "9", new Timestamp(System.currentTimeMillis()+200));

// æ‰§è¡Œè¡¨è¾¾å¼
boolean res = exe.execute(p1, p2);
```

### çŠ¶æ€è½¬æ¢ç¤ºä¾‹

æ£€æµ‹äº‹ä»¶å€¼ä» 0 å˜åŒ–åˆ° 1 çš„æƒ…å†µï¼š

```java
String code = "{==0}->{==1}";
Executor executor = Compiler.compile(code);
boolean res = executor.execute(eventData);
```

å¯¹äºç®€å•çš„ç­‰äºè¡¨è¾¾å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ›´ç®€æ´çš„è¯­æ³•ï¼š

```
<0,1>
```

ä¸€å¯¹å°–æ‹¬å·å†…çš„ 0 å’Œ 1 ç”¨é€—å·éš”å¼€ï¼Œè¡¨ç¤ºä» 0 å˜åŒ–åˆ° 1ã€‚

![state_transition_0_1](.\doc\media\videos\300p60\state_transition_enhanced.gif)

## ğŸ“ è¡¨è¾¾å¼è¯­æ³•

### ç®­å¤´è¡¨è¾¾å¼

ç®­å¤´è¡¨è¾¾å¼ç”¨äºè¡¨è¿°å¤šç§çŠ¶æ€çš„ä¾æ¬¡æ ¡éªŒã€‚è¯­æ³•å¦‚ä¸‹ï¼š

```
{çŠ¶æ€A}->{çŠ¶æ€B}->{çŠ¶æ€C}
```

èŠ±æ‹¬å· `{}` å†…æ˜¯æ‰€è¦è¡¨è¿°çš„çŠ¶æ€ï¼Œç®­å¤´ `->` è¡¨ç¤ºçŠ¶æ€çš„è¿ç§»é¡ºåºã€‚ä¾‹å¦‚ï¼š

```
{>1}->{count(<1,3)}->{==3}
```

è¿™ä¸ªè¡¨è¾¾å¼è¡¨ç¤ºï¼šå½“è¾“å…¥çš„æ•°æ®ä¾æ¬¡æ»¡è¶³"å¤§äº 1"ã€"ä¸‰æ¬¡ï¼ˆéè¿ç»­ï¼‰å°äº 1"ã€"ç­‰äº 3"æ—¶ï¼Œè¡¨è¾¾å¼æˆç«‹å¹¶è¿”å› trueã€‚

åªæœ‰å½“å‰ä¸€ä¸ªçŠ¶æ€æ»¡è¶³åï¼Œæ‰ä¼šç»§ç»­æ ¡éªŒä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚

### çŠ¶æ€è¡¨è¾¾å¼

èŠ±æ‹¬å·å†…çš„å†…å®¹ç§°ä¸ºçŠ¶æ€è¡¨è¾¾å¼æˆ–çŠ¶æ€æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

#### æ¯”è¾ƒè¡¨è¾¾å¼

ç”¨äºè¡¨ç¤ºæ•°æ®å€¼ä¹‹é—´çš„å¤§å°æ¯”è¾ƒï¼š

| è¡¨è¾¾å¼ | æè¿° | ç¤ºä¾‹ |
|-------|------|------|
| `>` | å¤§äº | `count(>4,3)` è¡¨ç¤ºè‹¥å¹²æ•°æ®ä¸­æœ‰ä¸‰ä¸ªå¤§äº 4, `count(>4.5,3)` è¡¨ç¤ºè‹¥å¹²æµ®ç‚¹æ•°ä¸­æœ‰ä¸‰ä¸ªå¤§äº 4.5 |
| `<` | å°äº | `count(<4,3)` è¡¨ç¤ºè‹¥å¹²æ•°æ®ä¸­æœ‰ä¸‰ä¸ªå°äº 4, `count(<4.2,3)` è¡¨ç¤ºè‹¥å¹²æµ®ç‚¹æ•°ä¸­æœ‰ä¸‰ä¸ªå°äº 4.2 |
| `>=` | å¤§äºç­‰äº | `{>=0.5}->{<=0.8}` è¡¨ç¤ºæ•°æ®éœ€è¦å…ˆæ»¡è¶³å¤§äºç­‰äº 0.5 ç„¶åæ»¡è¶³å°äºç­‰äº 0.8 |
| `<=` | å°äºç­‰äº | `{<=5.5}->{>=2.1}` è¡¨ç¤ºæ•°æ®éœ€è¦å…ˆæ»¡è¶³å°äºç­‰äº 5.5 ç„¶åæ»¡è¶³å¤§äºç­‰äº 2.1 |
| `==` | ç­‰äº | `{==3.14}->{==0.0}` è¡¨ç¤ºæ•°æ®éœ€è¦å…ˆç­‰äº 3.14 ç„¶åç­‰äº 0.0 |
| `!=` | ä¸ç­‰äº | `{!=0.0}->{!=5.5}` è¡¨ç¤ºæ•°æ®éœ€è¦å…ˆä¸ç­‰äº 0.0 ç„¶åä¸ç­‰äº 5.5 |

#### åŒºé—´è¡¨è¾¾å¼

ç”¨äºè¡¨ç¤ºæ•°æ®å¤„äºæŸä¸ªèŒƒå›´å†…ï¼Œè¯­æ³•å€Ÿé‰´äº†æ•°å­¦ä¸­çš„åŒºé—´è¡¨ç¤ºæ³•ï¼š

| è¡¨è¾¾å¼ | æè¿° | ç¤ºä¾‹ |
|-------|------|------|
| `(a,b)` | å¤§äº a ä¸”å°äº b | `(1,3)` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äº 1 ä¸”å°äº 3, `(1.5,3.5)` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äº 1.5 ä¸”å°äº 3.5 |
| `(a,b]` | å¤§äº a ä¸”å°äºç­‰äº b | `{(1,3]}->{(4,7)}` è¡¨ç¤ºæ•°æ®éœ€å…ˆæ»¡è¶³å¤§äº 1 ä¸”å°äºç­‰äº 3ï¼Œç„¶åæ»¡è¶³å¤§äº 4 å°äº 7 |
| `[a,b)` | å¤§äºç­‰äº a ä¸”å°äº b | `[1,3)` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äºç­‰äº 1 ä¸”å°äº 3, `[1.2,3.8)` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äºç­‰äº 1.2 ä¸”å°äº 3.8 |
| `[a,b]` | å¤§äºç­‰äº a ä¸”å°äºç­‰äº b | `[1,3]` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äºç­‰äº 1 ä¸”å°äºç­‰äº 3, `[0.5,2.5]` è¡¨ç¤ºæ•°æ®éœ€æ»¡è¶³å¤§äºç­‰äº 0.5 ä¸”å°äºç­‰äº 2.5 |

> ğŸ“Œ **æç¤º**ï¼šå·¦å³å°æ‹¬å·ï¼ˆ`()`ï¼‰è¡¨ç¤ºå¤§äº/å°äºï¼Œå·¦å³ä¸­æ‹¬å·ï¼ˆ`[]`ï¼‰è¡¨ç¤ºå¤§äºç­‰äº/å°äºç­‰äºã€‚

#### é€»è¾‘è¡¨è¾¾å¼

ç”¨äºç»„åˆå¤šä¸ªæ¡ä»¶ï¼ŒåŒ…æ‹¬ `||`ï¼ˆæˆ–ï¼‰ã€`&&`ï¼ˆä¸ï¼‰å’Œ `!`ï¼ˆéï¼‰ï¼š

- `||` æˆ–æ“ä½œï¼š`{==0||!=2}->{==1}` è¡¨ç¤ºæ•°æ®å…ˆæ»¡è¶³"ç­‰äº 0 æˆ–ä¸ç­‰äº 2"ï¼Œç„¶åæ»¡è¶³"ç­‰äº 1"

  ```java
  @Test
  void testOrOp() throws TranslatorException {
      String code = "{==0||!=2}->{==1}";
      Executor executor = Compiler.compile(code);
  
      EventData p1 = Util.genEventData("1", "3", new Timestamp(System.currentTimeMillis()));
      EventData p2 = Util.genEventData("2", "1", new Timestamp(System.currentTimeMillis()));
      Assertions.assertTrue(executor.execute(p1, p2)); // æ»¡è¶³è¯¥æ¡ä»¶
  }
  ```

- `&&` ä¸”æ“ä½œï¼š`{!=0&&!=2}->{==1}` è¡¨ç¤ºæ•°æ®å…ˆæ»¡è¶³"ä¸ç­‰äº 0 ä¸”ä¸ç­‰äº 2"ï¼Œç„¶åæ»¡è¶³"ç­‰äº 1"

- `!` éæ“ä½œï¼šä¸»è¦ç”¨äºä¸ç­‰äºè¡¨è¾¾å¼ï¼ˆ`!=`ï¼‰ä¸­

### é“¾å¼è¡¨è¾¾å¼

é“¾å¼è¡¨è¾¾å¼ç”¨äºå¯¹å¤šä¸ªæ•°æ®çš„é›†åˆè¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼š

```
filter((-5,5)).limit(5).take(0,2).sum().meet(>1)
```

è¿™ä¸ªè¡¨è¾¾å¼çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

1. å½“æ•°æ®å¤„äº -5 åˆ° 5 ä¹‹é—´ä¼šè¢«æ”¶é›†åˆ°ä¸€ä¸ªé›†åˆä¸­
2. é›†åˆæœ€å¤§åªèƒ½å®¹çº³ 5 ä¸ªæ•°æ®ï¼Œæ–°çš„ä¼šæ›¿æ¢æ—§çš„ï¼ˆé˜Ÿåˆ—ç‰¹æ€§ï¼‰
3. æ¯æ¬¡å–å‰ä¸¤ä¸ªæ•°æ®ï¼ˆç´¢å¼•ä¸åŒ…å« 2ï¼Œæ•°æ®ä¸æ»¡è¶³ä¸¤ä¸ªåˆ™ä¸ç»§ç»­åç»­æ“ä½œï¼‰
4. å¯¹å–å‡ºçš„æ•°æ®æ±‚å’Œ
5. å½“ç»“æœå¤§äº 1 æ—¶è¡¨è¾¾å¼æˆç«‹ï¼Œè¿”å› true

> ğŸ” **é“¾å¼è¡¨è¾¾å¼çš„ç¼–å†™å¯ä»¥åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†**ï¼š
> 1. è¿‡æ»¤å‡ºæƒ³è¦çš„æ•°æ®
> 2. é™åˆ¶æ•°æ®çš„èŒƒå›´ï¼ˆæ•°æ®ä¸ªæ•°æˆ–æ—¶é—´ï¼‰
> 3. è¿ç®—è§„åˆ™
> 4. ç¬¦åˆæ¡ä»¶

#### æ•°æ®è¿‡æ»¤

- **filter**

  filter å‡½æ•°æ”¾åœ¨é“¾å¼è¡¨è¾¾å¼çš„æœ€å‰é¢ï¼Œç”¨äºè¿‡æ»¤å‡ºæƒ³è¦çš„æ•°æ®ã€‚å¦‚æœä¸éœ€è¦è¿‡æ»¤æ•°æ®åˆ™å¯ä»¥ä¸å†™ã€‚filter å‡½æ•°å¯ä»¥ä¼ å…¥æ¯”è¾ƒè¡¨è¾¾å¼ã€åŒºé—´è¡¨è¾¾å¼ã€é€»è¾‘è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼š

  ```
  filter(((1,7]||>10)&&!=5) // å¯ä»¥ä½¿ç”¨å°æ‹¬å·()æ¥æŒ‡å®šè¿ç®—ä¼˜å…ˆçº§
  filter(<=3)
  ```

#### æ•°æ®çª—å£

- **limit** â±ï¸

  limit è¡¨ç¤ºæ•°æ®é™åˆ¶ï¼Œå¯ä»¥å¡«å†™æ—¶é—´æˆ–è€…ä¸ªæ•°ã€‚æ”¯æŒå¤šç§æ—¶é—´å•ä½ï¼Œæ–¹ä¾¿çµæ´»åœ°æ§åˆ¶æ•°æ®çª—å£å¤§å°ï¼š

  ```
  limit(100ms) // âš¡ é™åˆ¶ 100 æ¯«ç§’å†…çš„æ•°æ®
  limit(10s)   // ğŸ• é™åˆ¶ 10 ç§’å†…çš„æ•°æ®  
  limit(1m)    // ğŸ•’ é™åˆ¶ 1 åˆ†é’Ÿå†…çš„æ•°æ®
  limit(1h)    // ğŸ•• é™åˆ¶ 1 å°æ—¶å†…çš„æ•°æ®
  limit(1d)    // ğŸ“… é™åˆ¶ 1 å¤©å†…çš„æ•°æ®
  limit(10)    // ğŸ“Š é™åˆ¶ 10 ä¸ªæ•°æ®
  ```

  > ğŸ’¡ **æç¤º**: æ—¶é—´å•ä½ä»æ¯«ç§’åˆ°å¤©çš„è·¨åº¦,å¯ä»¥æ ¹æ®å®é™…åœºæ™¯çµæ´»é€‰æ‹©åˆé€‚çš„æ—¶é—´çª—å£

- **take**

  take å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºèµ·å§‹ç´¢å¼•ï¼ˆåŒ…å«ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºç©ºåˆ™é»˜è®¤å–åˆ°æœ€åä¸€ä¸ªå…ƒç´ ã€‚

  å‡è®¾å­˜åœ¨ä»¥ä¸‹åºåˆ—ï¼š`[0,1,2,3,4,5]`

  | è¡¨è¾¾å¼ | ç»“æœ |
  |-------|------|
  | `take(0,1)` | `[0]` |
  | `take(0,2)` | `[0,1]` |
  | `take(0,-1)` | `[0,1,2,3,4]` |
  | `take(-3,-1)` | `[3,4]` |
  | `take(-3)` | `[3,4,5]` |
  | `take(0)` | `[0,1,2,3,4,5]` |
#### æ•°æ®è®¡ç®—
Rhythmix æä¾›äº†å¤šç§æ•°æ®è®¡ç®—å‡½æ•°,ç”¨äºå¯¹æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æ:

- **sum**

  è®¡ç®—æ•°æ®åºåˆ—çš„æ€»å’Œã€‚æ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°çš„è®¡ç®—ã€‚

  ```js
  // æ•´æ•°åºåˆ— [10, 7, 10], sum() å°†è¿”å› 27
  filter(>0).sum()
  
  // æµ®ç‚¹æ•°åºåˆ— [10.5, 7.3, 10.2], sum() å°†è¿”å› 28.0
  filter(>0).sum()
  ```

- **avg** 

  è®¡ç®—æ•°æ®åºåˆ—çš„å¹³å‡å€¼ã€‚

  ```js
  // æ•´æ•°åºåˆ— [10, 7, 10], avg() å°†è¿”å› 9.0
  filter(>0).avg()
  
  // æµ®ç‚¹æ•°åºåˆ— [10.5, 7.3, 10.2], avg() å°†è¿”å› 9.33
  filter(>0).avg()
  ```

- **count**

  ç»Ÿè®¡æ•°æ®åºåˆ—ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚

  ```js
  // æ•´æ•°åºåˆ— [10, 7, 10], count() å°†è¿”å› 3
  filter(>0).count()
  
  // æµ®ç‚¹æ•°åºåˆ— [10.5, 7.3, 10.2], count() å°†è¿”å› 3
  filter(>0).count()
  ```

- **stddev**

  è®¡ç®—æ•°æ®åºåˆ—çš„æ ‡å‡†å·®ã€‚éœ€è¦è‡³å°‘ä¸¤ä¸ªæ•°æ®ç‚¹æ‰èƒ½è®¡ç®—ã€‚ç»“æœä¿ç•™3ä½å°æ•°ã€‚

  ```js
  // æ•´æ•°åºåˆ— [10, 7, 10], stddev() å°†è¿”å› 1.414
  filter(>0).stddev()
  
  // æµ®ç‚¹æ•°åºåˆ— [10.5, 7.3, 10.2], stddev() å°†è¿”å› 1.473
  filter(>0).stddev()
  ```

> ğŸ’¡ **æ³¨æ„**:
> - æ‰€æœ‰è®¡ç®—å‡½æ•°éƒ½ä¼šè‡ªåŠ¨å¿½ç•¥ç©ºå€¼
> - å¯¹äºéæ•°å€¼ç±»å‹çš„æ•°æ®å°†æŠ›å‡ºè®¡ç®—å¼‚å¸¸
> - æ ‡å‡†å·®è®¡ç®—è‡³å°‘éœ€è¦2ä¸ªæ•°æ®ç‚¹
> - å½“è¾“å…¥åºåˆ—åŒ…å«æµ®ç‚¹æ•°æ—¶,è®¡ç®—ç»“æœä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæµ®ç‚¹æ•°ç±»å‹


---
